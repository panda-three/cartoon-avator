# MVP 需求文档：一张自拍生成卡通头像

版本：v0.1（MVP）  
目标上线：待定  

## 0. 关键决策（已定）
- 支付平台：Creem（订阅制）
- 图片保存期：默认 7 天
- 额度扣减：生成成功后扣；失败不扣
- 推理方式：第三方图片生成 API（OpenRouter）
- 生图模型：OpenRouter 上的 Gemini Image Generation（以控制台 model id 为准；文档示例：`google/gemini-2.5-flash-image-preview`）

## 1. 背景与目标

用户上传 1 张自拍，选择预设画风，一键生成一组“同画风”的卡通形象照（头像为主），支持订阅制付费与额度管理。

### 目标
- 让用户在 30 秒内完成「上传 → 选风格 → 看到结果」
- 画风效果稳定（优先级：画风 > 像本人 > 速度）
- 订阅制可用：支付、权限校验、额度扣减、到期处理

### 非目标（MVP 不做）
- 多张照片训练（LoRA / DreamBooth）
- 自定义长 Prompt 编辑器（只提供少量开关/滑杆）
- 社区/作品广场/公开作品页
- 线下周边打印、批量商用授权流程

## 2. 目标用户与使用场景
- 需要社交头像/个人品牌视觉的人群（社交平台、社群、游戏、内容创作者）
- 不想公开真实照片，但希望“可识别”的匿名头像
- 想快速获得特定画风头像，不愿与画师反复沟通

## 3. 核心用户故事（MVP）
- 作为用户，我想上传一张自拍并选择「日漫线稿」风格，生成 4 张头像供我挑选下载。
- 作为订阅用户，我想在账户页看到当月剩余额度、账单状态、到期时间。
- 作为用户，我希望可以删除我上传的原图和生成结果，避免长期留存。

## 4. 用户流程（MVP）
1) 访问首页，浏览风格示例与订阅价格  
2) 登录/注册（MVP：邮箱或第三方登录，二选一即可）  
3) 购买订阅（按月自动续费）  
4) 创建生成任务：上传 1 张自拍 → 选择风格包 →（可选）调节「更像画风 / 更像本人」→ 点击生成  
5) 等待生成（展示进度/排队）  
6) 查看结果：4 张预览 → 选择下载（JPG/PNG）  
7) （可选）在同一风格下“再生成一组”或微调参数再生成  
8) 在历史记录中查看/下载/删除

## 5. 页面与模块（MVP）

### 5.1 首页 `/`
- 价值主张（1 句话）+ 3 步流程
- 风格包画廊（示例图、风格名称、标签）
- 订阅价格与权益（额度、并发、高清下载）
- FAQ：隐私、版权、退款（最简）

### 5.2 创建页 `/create`
- 上传组件（1 张，限制大小/格式；提示“正脸、无遮挡、光线充足”）
- 风格包选择（卡片列表）
- 参数（MVP 仅保留 1–2 个）
  - 「更像画风 / 更像本人」滑杆（默认偏画风）
  - （可选）色调/线条强度开关（每个风格包可配置是否展示）
- 生成按钮 + 额度提示（本次将消耗 X 次）

### 5.3 结果页 `/jobs/{id}`
- 状态：排队中/生成中/成功/失败（失败给可重试文案）
- 成功：4 张图网格 + 单张放大预览
- 操作：下载、再生成一组（同参数）、调整参数后再生成

### 5.4 账户页 `/account`
- 当前订阅状态（有效/已取消/已过期）
- 当月额度（总量、已用、剩余）
- 账单入口（跳转 Creem 客户门户）
- 数据管理：删除历史记录/删除全部图片

### 5.5 登录与支付（MVP）
- 登录页 `/login`：最少实现一种方式（邮箱 magic link 或 Google 登录）
- 价格页 `/pricing`：展示档位与订阅按钮
- Creem Webhook 回调：更新订阅状态、到期时间、扣款失败等（必需）

## 6. 功能需求（MVP）

### 6.1 风格包（核心）
- 风格包包含以下配置（由运营/管理员预置，用户不可编辑）
  - 名称、示例图、标签
  - 生成提示词模板（prompt / negative prompt）
  - 画风权重参数（如风格 LoRA 权重/强度）
  - 推荐输出尺寸与基础采样参数
- 首发风格包数量：6–10 个（可后续加）

#### 6.1.1 首发风格包清单（建议）
示例图：开发期可先用占位图；上线前用“内置 Demo 自拍（已授权）”为每个风格跑一次生成并替换为真实示例图（见「6.5」保存期与删除）。

- `anime-line`：日漫清线头像（线稿清晰、轻上色）→ `public/style-packs/anime-line/sample.svg`
- `anime-cel`：日漫赛璐璐（高对比、色块分明）→ `public/style-packs/anime-cel/sample.svg`
- `chibi`：Q 版大头（可爱夸张、头像友好）→ `public/style-packs/chibi/sample.svg`
- `webtoon`：条漫韩漫（干净线条、柔和阴影）→ `public/style-packs/webtoon/sample.svg`
- `western-comic`：美漫粗线（强轮廓、漫画质感）→ `public/style-packs/western-comic/sample.svg`
- `3d-toon`：3D 卡通（皮克斯感、软光）→ `public/style-packs/3d-toon/sample.svg`
- `flat-vector`：扁平矢量（品牌感、几何简化）→ `public/style-packs/flat-vector/sample.svg`
- `pixel`：像素头像（16/32-bit 像素风）→ `public/style-packs/pixel/sample.svg`
- `watercolor`：水彩插画（纸纹、柔和晕染）→ `public/style-packs/watercolor/sample.svg`
- `clay`：粘土定格（黏土材质、手作感）→ `public/style-packs/clay/sample.svg`

### 6.2 图片生成
- 输入：1 张用户上传自拍（服务端做基础校验与可选人脸检测/裁切）
- 输出：默认 4 张（固定，MVP 不开放数量选择）
- 生成方式：调用 OpenRouter 图片生成（异步任务）
- 任务状态：
  - `queued` → `running` → `succeeded` / `failed` / `canceled`
- 失败处理：
  - 可重试（成功后扣额度；失败不扣）
  - 给出通用原因（人脸不清晰/超时/服务不可用）

#### 6.2.1 OpenRouter 调用约束（MVP）
- Endpoint：`POST https://openrouter.ai/api/v1/chat/completions`
- 关键参数：`model`、`messages`、`modalities: ["image","text"]`、（可选）`image_config`（1:1 头像建议）
- 输出：优先按 `choices[0].message.images[].image_url.url` 解析（可能是 `data:image/png;base64,...` 或 URL）

#### 6.2.2 从自拍到“更像本人”的实现策略（MVP）
为降低对“原生 img2img”能力的依赖，MVP 采用两段式（后续可替换为更强身份保持方案）：
1) 视觉描述：用 Gemini 视觉模型从自拍提取可用于绘制的外观描述（发型/眼镜/表情/服饰要点等），产出结构化文本  
2) 风格生图：把「风格包提示词 + 外观描述」喂给 Gemini Image Generation 生成头像

### 6.3 订阅与额度
- 订阅档位（MVP 先 1–2 档）
  - 每月额度：按“生成一次=消耗 1 次（产出 4 张）”计
  - 并发限制：同一用户同时最多 1 个任务（MVP 默认）
- 权限规则：
  - 未订阅：不可创建任务（可浏览示例）
  - 订阅有效且额度>0：可创建任务
- 到期规则：
  - Creem 订阅到期/扣款失败：停止创建任务；历史结果仍可下载（保留期内）

### 6.4 历史记录
- 展示最近 N 次任务（MVP：最近 30 次）
- 支持下载与删除

### 6.5 隐私与内容安全（MVP 必需）
- 明示：上传照片用于生成，不用于公开展示；默认保存期 7 天
- 用户可一键删除原图与结果图
- 基础内容合规：
  - 禁止生成：色情、暴力、仇恨、未成年人不当内容、名人/政治敏感（按产品定位裁剪）
  - 上传图片与生成结果做基础审核（MVP 可仅做“上传限制 + 生成 API 自带安全”）

## 7. 非功能需求（MVP）
- 性能：创建任务后 1 秒内返回任务 ID；结果页轮询/推送更新
- 可用性：第三方服务异常时可降级提示，避免白屏
- 成本控制：额度 + 并发限制 + 单任务超时上限
- 观测：记录任务耗时、失败率、第三方调用错误码、用户转化漏斗

## 8. 数据结构（MVP，逻辑模型）
- User：`id`、`email`、`createdAt`
- Subscription：`userId`、`provider`、`status`、`currentPeriodEnd`、`planId`
- Usage（按月）：`userId`、`month`、`quotaTotal`、`quotaUsed`
- StylePack：`id`、`name`、`config`、`isActive`
- Job：`id`、`userId`、`stylePackId`、`status`、`inputImageUrl`、`outputImageUrls[]`、`params`、`createdAt`

## 9. 成功指标（MVP）
- 生成成功率（`succeeded / total`）≥ 90%
- 从 `/pricing` 到订阅成功转化率（自定目标，MVP 先观测）
- 平均生成耗时 P50/P90（用于优化体验与成本）
- 用户满意度信号：下载率、再生成率、退款率/取消率

## 10. MVP 验收清单（可手动验收）
- 未订阅用户：可浏览风格与价格，无法创建任务
- 订阅用户：可上传 1 张自拍并生成 4 张结果，可下载
- 任务状态可见：排队/生成/成功/失败，失败可重试
- 额度正确扣减，到期/取消后禁止继续生成
- 用户可在账户页删除历史图片（删除后不可再访问）

## 11. 待定问题（上线前必须定）
- 首发风格包清单与示例图来源（是否自制、是否可商用）
